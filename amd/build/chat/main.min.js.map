{"version":3,"file":"main.min.js","sources":["../../src/chat/main.js"],"sourcesContent":["/**\n * Main module for tutors experience view\n *\n * @module     local_digitalta/chat/main\n * @copyright  2024 ADSDR-FUNIBER Scepter Team\n */\n\nimport $ from 'jquery';\nimport Template from 'core/templates';\nimport Notification from 'core/notification';\nimport SELECTORS from 'local_digitalta/chat/selectors';\nimport { chatsGetRooms, chatsSendMessage, chatsGetMessage, markMessagesAsRead } from 'local_digitalta/repositories/chat_repository';\nimport setEventListeners from 'local_digitalta/chat/listeners';\nimport Status from 'local_digitalta/chat/status';\n\nconst status = new Status();\n\n/**\n * Create a chat in the target\n * @param {string} target\n * @param {int} experienceid\n * @param {boolean} single\n */\nexport default function createChatInTarget(target, experienceid = null, single = false) {\n    SELECTORS.TARGET = target;\n    initComponent(experienceid, single);\n    return;\n}\n\n/**\n * Initialize chat component\n * @param {*} experienceid\n * @param {*} single\n */\nconst initComponent = async (experienceid, single) => {\n    setEventListeners();\n    if (experienceid) {\n        openChatFromExperience(experienceid, single);\n    }\n    else {\n        renderMenuChat();\n    }\n    setInterval(reloaderMessages, 1000);\n};\n\n/**\n * Render menu chat\n */\nexport async function renderMenuChat() {\n    const { chatrooms } = await chatsGetRooms({experienceid: 0});\n    const chats = chatrooms.filter((chat) => chat.ownexperience === true);\n    const tutoringChats = chatrooms.filter((chat) => chat.ownexperience === false);\n    Template.render(SELECTORS.TEMPLATES.MENU_CHAT, {\n        tutoringChats : {\n            length: tutoringChats.length,\n            chats: tutoringChats,\n            unread: tutoringChats.filter((chat) => chat.unread_messages > 0).length\n        },\n        chats: {\n            length: chats.length,\n            chats: chats,\n            unread: chats.filter((chat) => chat.unread_messages > 0).length\n        },\n        isEmpty: tutoringChats.length === 0 && chats.length === 0\n    }).then((html) => {\n        $(SELECTORS.TARGET).html(html);\n        status.emptyActiveMessages();\n        SELECTORS.OPEN_CHAT_ID = 0;\n        return;\n    }).fail(Notification.exception);\n}\n\n/**\n * Open chat\n * @param {number} id\n * @param {boolean} hideBack\n * Render chat\n */\nexport async function renderSingleChat(id, hideBack = false) {\n    const { messages } = await chatsGetMessage({ chatid: id });\n    SELECTORS.OPEN_CHAT_ID = id;\n    Template.render(SELECTORS.TEMPLATES.SINGLE_CHAT, {\n        hideBack\n    }).then((html) => {\n        $(SELECTORS.TARGET).html(html);\n        handlerMessages(messages);\n        status.activeMessages = messages;\n        return;\n    }).fail(Notification.exception);\n}\n\n/**\n * Open chat\n * @param {number} id\n * @param {boolean} hideBack\n * Render chat\n */\nexport async function renderChat(id, hideBack = false) {\n    const { messages, chatroom } = await chatsGetMessage({ chatid: id });\n    SELECTORS.OPEN_CHAT_ID = id;\n    Template.render(SELECTORS.TEMPLATES.CHAT, {\n        hideBack, chatroom\n    }).then((html) => {\n        $(SELECTORS.TARGET).html(html);\n        handlerMessages(messages);\n        status.activeMessages = messages;\n        return;\n    }).fail(Notification.exception);\n    await markMessagesAsRead({ chatid: id });\n}\n\n\n/**\n * Render messages in chat\n * @param {Array} messages\n */\nexport async function handlerMessages(messages) {\n    let html = '';\n    const promises = messages.map((msg) => {\n        const { message, timecreated, is_mine, userfullname, userpicture} = msg;\n        return renderMessage(message, timecreated, is_mine, userfullname, userpicture);\n    });\n    try {\n        html = (await Promise.all(promises)).join('');\n        $(SELECTORS.CONTAINERS.MESSAGES).html(html);\n    } catch (error) {\n        Notification.exception(error);\n    }\n}\n/**\n * Reload messages\n */\nexport async function reloaderMessages() {\n    if (SELECTORS.OPEN_CHAT_ID) {\n        const { messages } = await chatsGetMessage({ chatid: SELECTORS.OPEN_CHAT_ID });\n        handlerNewOtherMessage(messages);\n        return;\n    }\n}\n\n/**\n * Handler new other message\n * @param {object} messages\n */\nexport async function handlerNewOtherMessage(messages) {\n    const newMessages = findDefferencies(messages, status.activeMessages);\n    const promises = newMessages.map((msg) => {\n        const { message, timecreated, is_mine, userfullname, userpicture } = msg;\n        status.activeMessages.push(msg);\n        return renderMessage(message, timecreated, is_mine, userfullname, userpicture);\n    });\n    if (newMessages.length > 0) {\n        await markMessagesAsRead({ chatid: SELECTORS.OPEN_CHAT_ID, messageids: newMessages.map((msg) => msg.id) });\n    }\n    try {\n        const html = (await Promise.all(promises)).join('');\n        $(SELECTORS.CONTAINERS.MESSAGES).append(html);\n    } catch (error) {\n        Notification.exception(error);\n    }\n}\n\n/**\n * Check if two objects are equals\n * @param {Array} arr1\n * @param {Array} arr2\n * @returns {Array}\n */\nfunction findDefferencies(arr1, arr2) {\n    return arr1.filter(objeto1 => {\n        return !arr2.some(objeto2 => areEqualsByid(objeto1, objeto2));\n    });\n}\n\n/**\n * Check if two objects are equals\n * @param {object} objeto1\n * @param {object} objeto2\n * @returns {boolean}\n */\nfunction areEqualsByid(objeto1, objeto2) {\n    return objeto1.message === objeto2.message && objeto1.timecreated === objeto2.timecreated;\n}\n\n/**\n * Render my message\n * @param {string} text\n * @param {string} time\n * @param {boolean} mine\n * @param {string} userfullname\n * @param {string} userpicture\n * @returns {Promise}\n */\nexport async function renderMessage(text, time, mine, userfullname = '', userpicture = '') {\n    const TEMPLATE = mine ? SELECTORS.TEMPLATES.MY_MESSAGE : SELECTORS.TEMPLATES.OTHER_MESSAGE;\n    const timeInMilliseconds = time * 1000;\n    let dateString = '';\n    if (timeInMilliseconds < (Date.now() - (86400000))) {\n        dateString = new Date(timeInMilliseconds).toLocaleDateString();\n    }\n    const timeString =  new Date(time*1000).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' });\n    const dateTimeString = dateString ? `${dateString} ${timeString}` : timeString;\n    return Template.render(TEMPLATE, {text, time: dateTimeString, userfullname, userpicture});\n}\n\n/**\n * Handle send message\n * @returns {Promise}\n */\nexport async function handleSendMessage() {\n    const message = $(SELECTORS.INPUTS.CHAT_REPLY).val().trim();\n    chatsSendMessage({\n        chatid: SELECTORS.OPEN_CHAT_ID,\n        message,\n    }).then(() => {\n        $(SELECTORS.INPUTS.CHAT_REPLY).val('');\n        addNewMessage(message);\n        return;\n    }).fail(Notification.exception);\n    return;\n}\n\n/**\n * Add new message\n * @param {string} message\n */\nasync function addNewMessage(message) {\n    const date = Math.floor(Date.now() / 1000);\n    const html = await renderMessage(message, date, true);\n    status.activeMessages.push({\n        message,\n        timecreated: date,\n        is_mine: true\n    });\n\n    $(SELECTORS.CONTAINERS.MESSAGES).append(html);\n}\n\n/**\n * Open chat from experience\n * @param {int} experienceid\n * @param {boolean} single\n */\nexport async function openChatFromExperience(experienceid, single=true) {\n    const {chatrooms} = await chatsGetRooms({experienceid});\n    if (chatrooms.length === 0) {\n        return;\n    }\n    // eslint-disable-next-line @babel/no-unused-expressions\n    single ? renderSingleChat(chatrooms[0].id, true) : renderChat(experienceid);\n}\n\n/**\n * Render menu tutor\n * @returns {Promise}\n */\nexport async function renderMenuTutor() {\n    Template.render(SELECTORS.TEMPLATES.MENU_MENTOR, {}).then((html) => {\n        $(SELECTORS.TARGET).html(html);\n        return;\n    }).fail(Notification.exception);\n}"],"names":["target","experienceid","single","TARGET","initComponent","message","SELECTORS","INPUTS","CHAT_REPLY","val","trim","chatid","OPEN_CHAT_ID","then","date","Math","floor","Date","now","html","renderMessage","status","activeMessages","push","timecreated","is_mine","CONTAINERS","MESSAGES","append","addNewMessage","fail","Notification","exception","render","TEMPLATES","MENU_MENTOR","async","openChatFromExperience","renderMenuChat","setInterval","reloaderMessages","chatrooms","chats","filter","chat","ownexperience","tutoringChats","MENU_CHAT","length","unread","unread_messages","isEmpty","emptyActiveMessages","renderSingleChat","id","hideBack","messages","SINGLE_CHAT","handlerMessages","renderChat","chatroom","CHAT","promises","map","msg","userfullname","userpicture","Promise","all","join","error","handlerNewOtherMessage","newMessages","arr1","arr2","objeto1","some","objeto2","areEqualsByid","messageids","text","time","mine","TEMPLATE","MY_MESSAGE","OTHER_MESSAGE","timeInMilliseconds","dateString","toLocaleDateString","timeString","toLocaleTimeString","hour12","hour","minute","dateTimeString","Template"],"mappings":"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"}