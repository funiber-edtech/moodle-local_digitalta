{"version":3,"file":"main.min.js","sources":["../../src/chat/main.js"],"sourcesContent":["import $ from 'jquery';\r\nimport Template from 'core/templates';\r\nimport Notification from 'core/notification';\r\nimport SELECTORS from './selectors';\r\nimport { getChatRooms, sendMessage, getMessages } from 'local_dta/repositories/chat_repository';\r\nimport setEventListeners from './listeners';\r\nimport Status from './status';\r\nimport mentorHandler from 'local_dta/mentors/experience_view/main';\r\n\r\nconst status = new Status();\r\n\r\n/**\r\n * Create a chat in the target\r\n * @param {string} target\r\n * @param {int} experienceid\r\n */\r\nexport default function createChatInTarget(target, experienceid = null) {\r\n    SELECTORS.TARGET = target;\r\n    initComponent(experienceid);\r\n    return;\r\n}\r\n\r\n/**\r\n * Initialize chat component\r\n * @param {*} experienceid\r\n */\r\nconst initComponent = (experienceid) => {\r\n    setEventListeners();\r\n    if (experienceid) {\r\n        openChatFromExperience(experienceid);\r\n        return;\r\n    } else {\r\n        renderMenuChat();\r\n    }\r\n    setInterval(reloaderMessages, 1000);\r\n};\r\n\r\n/**\r\n * Render menu chat\r\n */\r\nexport async function renderMenuChat() {\r\n    const { chatrooms } = await getChatRooms({experienceid: 0});\r\n    Template.render(SELECTORS.TEMPLATES.MENU_CHAT, {\r\n        chatrooms\r\n    }).then((html) => {\r\n        $(SELECTORS.TARGET).html(html);\r\n        status.emptyActiveMessages();\r\n        SELECTORS.OPEN_CHAT_ID = 0;\r\n        mentorHandler();\r\n        return;\r\n    }).fail(Notification.exception);\r\n}\r\n\r\n/**\r\n * Open chat\r\n * @param {number} id\r\n * @param {boolean} hideBack\r\n * Render chat\r\n */\r\nexport async function renderChat(id, hideBack = false) {\r\n    const { messages } = await getMessages({ chatid: id });\r\n    SELECTORS.OPEN_CHAT_ID = id;\r\n    Template.render(SELECTORS.TEMPLATES.CHAT, {\r\n        hideBack\r\n    }).then((html) => {\r\n        $(SELECTORS.TARGET).html(html);\r\n        handlerMessages(messages);\r\n        status.activeMessages = messages;\r\n        return;\r\n    }).fail(Notification.exception);\r\n}\r\n\r\n\r\n/**\r\n * Render messages in chat\r\n * @param {Array} messages\r\n */\r\nexport async function handlerMessages(messages) {\r\n    let html = '';\r\n    const promises = messages.map((msg) => {\r\n        const { message, timecreated, is_mine } = msg;\r\n        return renderMessage(message, timecreated, is_mine);\r\n    });\r\n    try {\r\n        html = (await Promise.all(promises)).join('');\r\n        $(SELECTORS.CONTAINERS.MESSAGES).html(html);\r\n    } catch (error) {\r\n        Notification.exception(error);\r\n    }\r\n}\r\n/**\r\n * Reload messages\r\n */\r\nexport async function reloaderMessages() {\r\n    if (SELECTORS.OPEN_CHAT_ID) {\r\n        const { messages } = await getMessages({ chatid: SELECTORS.OPEN_CHAT_ID });\r\n        handlerNewOtherMessage(messages);\r\n        return;\r\n    }\r\n}\r\n\r\n/**\r\n * Handler new other message\r\n * @param {object} messages\r\n */\r\nexport async function handlerNewOtherMessage(messages) {\r\n    const newMessages = findDefferencies(messages, status.activeMessages);\r\n    const promises = newMessages.map((msg) => {\r\n        const { message, timecreated, is_mine } = msg;\r\n        status.activeMessages.push(msg);\r\n        return renderMessage(message, timecreated, is_mine);\r\n    });\r\n    try {\r\n        const html = (await Promise.all(promises)).join('');\r\n        $(SELECTORS.CONTAINERS.MESSAGES).append(html);\r\n    } catch (error) {\r\n        Notification.exception(error);\r\n    }\r\n}\r\n\r\n/**\r\n * Check if two objects are equals\r\n * @param {Array} arr1\r\n * @param {Array} arr2\r\n * @returns {Array}\r\n */\r\nfunction findDefferencies(arr1, arr2) {\r\n    return arr1.filter(objeto1 => {\r\n        return !arr2.some(objeto2 => areEqualsByid(objeto1, objeto2));\r\n    });\r\n}\r\n\r\n/**\r\n * Check if two objects are equals\r\n * @param {object} objeto1\r\n * @param {object} objeto2\r\n * @returns {boolean}\r\n */\r\nfunction areEqualsByid(objeto1, objeto2) {\r\n    return objeto1.message === objeto2.message;\r\n}\r\n\r\n/**\r\n * Render my message\r\n * @param {string} text\r\n * @param {string} time\r\n * @param {boolean} mine\r\n * @returns {Promise}\r\n */\r\nexport async function renderMessage(text, time, mine) {\r\n    const TEMPLATE = mine ? SELECTORS.TEMPLATES.MY_MESSAGE : SELECTORS.TEMPLATES.OTHER_MESSAGE;\r\n    return Template.render(TEMPLATE, { text, time });\r\n}\r\n\r\n/**\r\n * Handle send message\r\n * @returns {Promise}\r\n */\r\nexport async function handleSendMessage() {\r\n    const message = $(SELECTORS.INPUTS.CHAT_REPLY).val().trim();\r\n    sendMessage({\r\n        chatid: SELECTORS.OPEN_CHAT_ID,\r\n        message,\r\n    }).then(() => {\r\n        $(SELECTORS.INPUTS.CHAT_REPLY).val('');\r\n        addNewMessage(message);\r\n        return;\r\n    }).fail(Notification.exception);\r\n    return;\r\n}\r\n\r\n/**\r\n * Add new message\r\n * @param {string} message\r\n */\r\nasync function addNewMessage(message) {\r\n    const date = new Date().toLocaleTimeString('es-ES', { hour12: false, hour: '2-digit', minute: '2-digit' });\r\n    const html = await renderMessage(message, date, true);\r\n    status.activeMessages.push({ message, timecreated: date, is_mine: true });\r\n\r\n    $(SELECTORS.CONTAINERS.MESSAGES).append(html);\r\n}\r\n\r\n/**\r\n * Open chat from experience\r\n * @param {int} experienceid\r\n */\r\nexport async function openChatFromExperience(experienceid) {\r\n    const {chatrooms} = await getChatRooms({experienceid});\r\n    renderChat(chatrooms[0].id, true);\r\n}"],"names":["target","experienceid","TARGET","initComponent","message","SELECTORS","INPUTS","CHAT_REPLY","val","trim","chatid","OPEN_CHAT_ID","then","date","Date","toLocaleTimeString","hour12","hour","minute","html","renderMessage","status","activeMessages","push","timecreated","is_mine","CONTAINERS","MESSAGES","append","addNewMessage","fail","Notification","exception","Status","openChatFromExperience","renderMenuChat","setInterval","reloaderMessages","chatrooms","render","TEMPLATES","MENU_CHAT","emptyActiveMessages","renderChat","id","hideBack","messages","CHAT","handlerMessages","promises","map","msg","Promise","all","join","error","handlerNewOtherMessage","arr1","arr2","filter","objeto1","some","objeto2","areEqualsByid","text","time","mine","TEMPLATE","MY_MESSAGE","OTHER_MESSAGE","Template"],"mappings":"8dAgB2CA,YAAQC,oEAAe,+BACpDC,OAASF,YACnBG,cAAcF,iEA6IRG,SAAU,mBAAEC,mBAAUC,OAAOC,YAAYC,MAAMC,mDACzC,CACRC,OAAQL,mBAAUM,aAClBP,QAAAA,UACDQ,MAAK,yBACFP,mBAAUC,OAAOC,YAAYC,IAAI,mBAWdJ,eACnBS,MAAO,IAAIC,MAAOC,mBAAmB,QAAS,CAAEC,QAAQ,EAAOC,KAAM,UAAWC,OAAQ,YACxFC,WAAaC,cAAchB,QAASS,MAAM,GAChDQ,OAAOC,eAAeC,KAAK,CAAEnB,QAAAA,QAASoB,YAAaX,KAAMY,SAAS,wBAEhEpB,mBAAUqB,WAAWC,UAAUC,OAAOT,MAfpCU,CAAczB,YAEf0B,KAAKC,sBAAaC,inBA9JnBX,OAAS,IAAIY,sBAiBb9B,cAAiBF,wCAEfA,aACAiC,uBAAuBjC,eAGvBkC,iBAEJC,YAAYC,iBAAkB,sBAMZF,uBACZG,UAAEA,iBAAoB,iCAAa,CAACrC,aAAc,uBAC/CsC,OAAOlC,mBAAUmC,UAAUC,UAAW,CAC3CH,UAAAA,YACD1B,MAAMO,2BACHd,mBAAUH,QAAQiB,KAAKA,MACzBE,OAAOqB,yCACG/B,aAAe,yBAG1BmB,KAAKC,sBAAaC,0BASHW,WAAWC,QAAIC,uEAC3BC,SAAEA,gBAAmB,gCAAY,CAAEpC,OAAQkC,wBACvCjC,aAAeiC,sBAChBL,OAAOlC,mBAAUmC,UAAUO,KAAM,CACtCF,SAAAA,WACDjC,MAAMO,2BACHd,mBAAUH,QAAQiB,KAAKA,MACzB6B,gBAAgBF,UAChBzB,OAAOC,eAAiBwB,YAEzBhB,KAAKC,sBAAaC,0BAQHgB,gBAAgBF,cAC9B3B,KAAO,SACL8B,SAAWH,SAASI,KAAKC,YACrB/C,QAAEA,QAAFoB,YAAWA,YAAXC,QAAwBA,SAAY0B,WACnC/B,cAAchB,QAASoB,YAAaC,gBAG3CN,YAAciC,QAAQC,IAAIJ,WAAWK,KAAK,wBACxCjD,mBAAUqB,WAAWC,UAAUR,KAAKA,MACxC,MAAOoC,6BACQvB,UAAUuB,uBAMTlB,sBACdhC,mBAAUM,oBACJmC,SAAEA,gBAAmB,gCAAY,CAAEpC,OAAQL,mBAAUM,eAC3D6C,uBAAuBV,+BASTU,uBAAuBV,cAqBnBW,KAAMC,WAnBtBT,UAmBgBQ,KApBeX,SAoBTY,KApBmBrC,OAAOC,eAqB/CmC,KAAKE,QAAOC,UACPF,KAAKG,MAAKC,kBAUHF,QAASE,gBACrBF,QAAQxD,UAAY0D,QAAQ1D,QAXF2D,CAAcH,QAASE,cArB3BZ,KAAKC,YACxB/C,QAAEA,QAAFoB,YAAWA,YAAXC,QAAwBA,SAAY0B,WAC1C9B,OAAOC,eAAeC,KAAK4B,KACpB/B,cAAchB,QAASoB,YAAaC,sBAGrCN,YAAciC,QAAQC,IAAIJ,WAAWK,KAAK,wBAC9CjD,mBAAUqB,WAAWC,UAAUC,OAAOT,MAC1C,MAAOoC,6BACQvB,UAAUuB,uBAiCTnC,cAAc4C,KAAMC,KAAMC,YACtCC,SAAWD,KAAO7D,mBAAUmC,UAAU4B,WAAa/D,mBAAUmC,UAAU6B,qBACtEC,mBAAS/B,OAAO4B,SAAU,CAAEH,KAAAA,KAAMC,KAAAA,sBAoCvB/B,uBAAuBjC,oBACnCqC,UAACA,iBAAmB,iCAAa,CAACrC,aAAAA,eACxC0C,WAAWL,UAAU,GAAGM,IAAI"}